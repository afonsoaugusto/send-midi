<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>send-midi</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f4f4;
            margin: 0;
            padding: 0;
        }

        .container {
            display: flex;
            flex-direction: row;
            max-width: 700px;
            margin: 40px auto;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px #0001;
            min-height: 400px;
            overflow: hidden;
        }

        .sidebar {
            width: 220px;
            background: #f0f0f0;
            border-right: 1px solid #e0e0e0;
            padding: 0;
            display: flex;
            flex-direction: column;
        }

        .sidebar h2 {
            text-align: center;
            font-size: 1.1em;
            margin: 18px 0 10px 0;
            color: #1976d2;
        }

        .song-list {
            flex: 1;
            overflow-y: auto;
        }

        .song-list-item {
            padding: 14px 18px;
            cursor: pointer;
            border-bottom: 1px solid #e0e0e0;
            background: none;
            text-align: left;
            font-size: 1em;
            transition: background 0.2s;
        }

        .song-list-item.selected,
        .song-list-item:hover {
            background: #e3eaff;
            font-weight: bold;
        }

        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 32px 24px;
        }

        .main h1 {
            text-align: center;
            margin-bottom: 24px;
        }

        .song-title {
            font-weight: bold;
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .midi-info {
            margin: 8px 0 18px 0;
            color: #555;
        }

        .send-btn {
            background: #1976d2;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 10px 24px;
            cursor: pointer;
            font-size: 1.1em;
            transition: background 0.2s;
        }

        .send-btn:disabled,
        .send-btn.sending {
            background: #aaa;
            cursor: not-allowed;
        }

        .status {
            margin-top: 18px;
            text-align: center;
            color: #1976d2;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="sidebar">
            <h2>Músicas</h2>
            <div class="song-list" id="songList"></div>
        </div>
        <div class="main">
            <h1>send-midi</h1>
            <div id="selectedSong"></div>
            <div class="status" id="status"></div>
        </div>
    </div>
    <script src="midi-utils.js"></script>
    <script>
        let songs = [];
        let selectedIdx = 0;
        const songListDiv = document.getElementById('songList');
        const selectedSongDiv = document.getElementById('selectedSong');
        const statusDiv = document.getElementById('status');
        let midiAccess = null;
        let midiOutput = null;
        let sending = false;

        async function loadSongs() {
            try {
                const resp = await fetch('songs.json');
                songs = await resp.json();
                renderSongList();
                renderSelectedSong();
            } catch (e) {
                songListDiv.innerHTML = '<div style="padding:16px">Erro ao carregar lista de músicas.</div>';
            }
        }

        function renderSongList() {
            songListDiv.innerHTML = '';
            songs.forEach((song, idx) => {
                const btn = document.createElement('button');
                btn.className = 'song-list-item' + (idx === selectedIdx ? ' selected' : '');
                btn.textContent = song.name;
                btn.onclick = () => {
                    selectedIdx = idx;
                    renderSongList();
                    renderSelectedSong();
                };
                songListDiv.appendChild(btn);
            });
        }

        function renderSelectedSong() {
            selectedSongDiv.innerHTML = '';
            if (!songs[selectedIdx]) return;
            const song = songs[selectedIdx];
            const title = document.createElement('div');
            title.className = 'song-title';
            title.textContent = song.name || `BPM: ${song.bpm}`;
            // Gera as mensagens MIDI a partir do BPM
            let midiMsgs = convertBPMToMidi(song.bpm);
            let midiInfo = document.createElement('div');
            midiInfo.className = 'midi-info';
            if (midiMsgs) {
                midiInfo.innerHTML = `BPM: ${song.bpm} &nbsp;|&nbsp; Canal MIDI: 74, Value: ${midiMsgs[0].value} &nbsp;|&nbsp; Canal MIDI: 75, Value: ${midiMsgs[1].value}`;
            } else {
                midiInfo.innerHTML = `BPM inválido (${song.bpm}). Use 40-300.`;
            }
            const btn = document.createElement('button');
            btn.className = 'send-btn' + (sending ? ' sending' : '');
            btn.textContent = 'Enviar MIDI';
            btn.disabled = !midiOutput || sending || !midiMsgs;
            btn.onclick = async () => {
                if (!midiOutput || sending || !midiMsgs) return;
                sending = true;
                renderSelectedSong();
                midiMsgs.forEach(msg => {
                    midiOutput.send([0xB0, msg.channel, msg.value]);
                });
                statusDiv.textContent = `MIDI enviado para BPM: ${song.bpm}`;
                setTimeout(() => {
                    sending = false;
                    renderSelectedSong();
                }, 1200);
            };
            selectedSongDiv.appendChild(title);
            selectedSongDiv.appendChild(midiInfo);
            selectedSongDiv.appendChild(btn);
        }

        async function initMIDI() {
            if (!navigator.requestMIDIAccess) {
                statusDiv.textContent = 'Web MIDI API não suportada neste navegador.';
                return;
            }
            try {
                midiAccess = await navigator.requestMIDIAccess();
                const outputs = Array.from(midiAccess.outputs.values());
                if (outputs.length === 0) {
                    statusDiv.textContent = 'Nenhum dispositivo MIDI encontrado.';
                    return;
                }
                midiOutput = outputs[0];
                statusDiv.textContent = 'Dispositivo MIDI pronto: ' + midiOutput.name;
                renderSelectedSong();
            } catch (e) {
                statusDiv.textContent = 'Erro ao acessar MIDI: ' + e;
            }
        }

        loadSongs();
        initMIDI();
    </script>
</body>

</html>